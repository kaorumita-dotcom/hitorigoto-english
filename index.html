<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¬ã‚Šè¨€è‹±ä¼šè©± - English Speaking Practice</title>
    <meta name="description" content="1åˆ†é–“ã®è‹±èªã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ã‚¢ãƒ—ãƒª">
    <meta name="theme-color" content="#2856a3">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f4fa;
            --card: #ffffff;
            --primary: #2856a3;
            --primary-light: #e4ecf7;
            --primary-dark: #1a3b6e;
            --accent: #e8a84c;
            --accent-light: #fdf3e0;
            --text: #2c2c2c;
            --text-light: #6b6b6b;
            --border: #d8dfe8;
            --recording: #c0392b;
            --recording-light: #fdeaea;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.7; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px 16px 40px; }
        header { text-align: center; padding: 30px 0 20px; }
        header h1 { font-size: 1.6rem; font-weight: 700; color: var(--primary-dark); }
        header h1 span { display: block; font-size: 0.85rem; font-weight: 400; color: var(--text-light); margin-top: 4px; letter-spacing: 0.05em; }
        .topic-card { background: var(--card); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); text-align: center; }
        .topic-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--accent); font-weight: 600; margin-bottom: 10px; }
        .topic-text { font-size: 1.15rem; font-weight: 600; color: var(--text); line-height: 1.5; }
        .topic-text-en { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
        .new-topic-btn { margin-top: 14px; background: none; border: 1.5px solid var(--border); padding: 8px 18px; border-radius: 20px; font-size: 0.8rem; font-family: 'DM Sans', 'Noto Sans JP', sans-serif; color: var(--text-light); cursor: pointer; transition: all 0.2s; }
        .new-topic-btn:hover { border-color: var(--primary); color: var(--primary); }
        .recording-area { background: var(--card); border-radius: var(--radius); padding: 32px 24px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); text-align: center; transition: all 0.3s; }
        .recording-area.is-recording { border-color: var(--recording); background: var(--recording-light); box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1); }
        .timer { font-size: 3.2rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--primary-dark); margin-bottom: 6px; }
        .recording-area.is-recording .timer { color: var(--recording); }
        .timer-label { font-size: 0.8rem; color: var(--text-light); margin-bottom: 24px; }
        .record-btn { width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 1.8rem; cursor: pointer; transition: all 0.25s; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 4px 16px rgba(40, 86, 163, 0.3); }
        .record-btn:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(40, 86, 163, 0.4); }
        .record-btn.recording { background: var(--recording); box-shadow: 0 4px 16px rgba(192, 57, 43, 0.3); animation: pulse 1.5s infinite; }
        .record-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.3); } 50% { box-shadow: 0 0 0 14px rgba(192, 57, 43, 0); } }
        .record-btn-label { margin-top: 14px; font-size: 0.85rem; font-weight: 500; color: var(--text-light); }
        .recording-area.is-recording .record-btn-label { color: var(--recording); }
        .audio-level { display: none; margin-top: 16px; height: 6px; background: rgba(255,255,255,0.5); border-radius: 3px; overflow: hidden; }
        .recording-area.is-recording .audio-level { display: block; }
        .audio-level-bar { height: 100%; background: var(--recording); border-radius: 3px; transition: width 0.1s; width: 0%; }
        .results-section { display: none; }
        .results-section.visible { display: block; }
        .result-card { background: var(--card); border-radius: var(--radius); padding: 24px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .result-card h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .stat-box { background: var(--primary-light); border-radius: 12px; padding: 16px; text-align: center; }
        .stat-box .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--primary-dark); }
        .stat-box .stat-label { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
        .stat-box.cefr { background: var(--accent-light); }
        .stat-box.cefr .stat-value { color: var(--accent); }
        .good-point { padding: 10px 14px; background: var(--primary-light); border-radius: 10px; margin-bottom: 8px; border-left: 3px solid var(--primary); }
        .grammar-point { padding: 10px 14px; background: #fff8f0; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid var(--accent); }
        .encouragement { padding: 14px; background: linear-gradient(135deg, var(--primary-light), var(--accent-light)); border-radius: 10px; margin-top: 8px; text-align: center; font-weight: 500; }
        .transcript-text { font-size: 0.88rem; line-height: 1.8; color: var(--text); padding: 14px; background: var(--bg); border-radius: 10px; }
        .processing-card { background: var(--card); border-radius: var(--radius); padding: 30px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); text-align: center; display: none; }
        .processing-card.visible { display: block; }
        .loading-dots { display: inline-flex; gap: 6px; }
        .loading-dots span { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); animation: loadBounce 1.2s infinite; }
        .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes loadBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
        .loading-text { margin-top: 12px; font-size: 0.85rem; color: var(--text-light); }
        .try-again-btn { display: block; width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; font-family: 'DM Sans', 'Noto Sans JP', sans-serif; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px rgba(40, 86, 163, 0.2); }
        .try-again-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .error-msg { background: var(--recording-light); border: 1px solid var(--recording); border-radius: 10px; padding: 14px; font-size: 0.85rem; color: var(--recording); margin-bottom: 12px; display: none; }
        .error-msg.visible { display: block; }
        footer { text-align: center; padding: 20px 0; font-size: 0.75rem; color: var(--text-light); }
        @media (max-width: 400px) { .timer { font-size: 2.6rem; } .container { padding: 12px 12px 30px; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ—£ï¸ ç‹¬ã‚Šè¨€è‹±ä¼šè©±<span>English Speaking Practice</span></h1>
    </header>

    <div class="topic-card">
        <div class="topic-label">Today's Topic</div>
        <div class="topic-text" id="topicText"></div>
        <div class="topic-text-en" id="topicTextEn"></div>
        <button class="new-topic-btn" onclick="changeTopic()">ğŸ”„ åˆ¥ã®ãƒˆãƒ”ãƒƒã‚¯</button>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <div class="recording-area" id="recordingArea">
        <div class="timer" id="timer">1:00</div>
        <div class="timer-label">åˆ¶é™æ™‚é–“</div>
        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
        <div class="record-btn-label" id="recordBtnLabel">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</div>
        <div class="audio-level"><div class="audio-level-bar" id="audioLevelBar"></div></div>
    </div>

    <div class="processing-card" id="processingCard">
        <div class="loading-dots"><span></span><span></span><span></span></div>
        <div class="loading-text" id="processingText">éŸ³å£°ã‚’è§£æä¸­...</div>
    </div>

    <div class="results-section" id="resultsSection">
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="wpmValue">--</div>
                <div class="stat-label">èªæ•° / åˆ†</div>
            </div>
            <div class="stat-box cefr">
                <div class="stat-value" id="cefrValue">--</div>
                <div class="stat-label">CEFRãƒ¬ãƒ™ãƒ«</div>
            </div>
        </div>
        <div class="result-card">
            <h3>ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
            <div id="feedbackContent"></div>
        </div>
        <div class="result-card">
            <h3>ğŸ™ï¸ ã‚ãªãŸã®ã‚¹ãƒ”ãƒ¼ãƒï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰</h3>
            <div class="transcript-text" id="finalTranscript"></div>
        </div>
        <button class="try-again-btn" onclick="resetApp()">ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
    </div>

    <footer>å®Ÿè·µå¥³å­å¤§å­¦ å›½éš›å­¦éƒ¨ è‹±èªå­¦ç¿’ãƒ„ãƒ¼ãƒ«</footer>
</div>

<script>
// ============================================================
// Configuration - Cloudflare Worker proxy URL
// ============================================================
const API_BASE = 'https://hitorigoto-api.kaorumita.workers.dev';

// ============================================================
// Topics
// ============================================================
const topics = [
    { ja: "å¥½ããªæ˜ ç”»ã‚„ãƒ†ãƒ¬ãƒ“ç•ªçµ„", en: "Your favorite movie or TV show" },
    { ja: "é€±æœ«ã®éã”ã—æ–¹", en: "How you spend your weekends" },
    { ja: "å¥½ããªé£Ÿã¹ç‰©", en: "Your favorite food" },
    { ja: "æœ€è¿‘è¡Œã£ãŸå ´æ‰€", en: "A place you visited recently" },
    { ja: "å°†æ¥ã®å¤¢", en: "Your dream for the future" },
    { ja: "è¶£å‘³ã«ã¤ã„ã¦", en: "About your hobbies" },
    { ja: "å¥½ããªå­£ç¯€", en: "Your favorite season" },
    { ja: "ãƒšãƒƒãƒˆã‚„å‹•ç‰©ã«ã¤ã„ã¦", en: "About pets or animals" },
    { ja: "æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³", en: "Your morning routine" },
    { ja: "å¥½ããªéŸ³æ¥½", en: "Your favorite music" },
    { ja: "æ—…è¡Œã§è¡ŒããŸã„å ´æ‰€", en: "A place you want to travel to" },
    { ja: "å¤§å­¦ç”Ÿæ´»ã«ã¤ã„ã¦", en: "About your university life" },
    { ja: "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ä½¿ã„æ–¹", en: "How you use your smartphone" },
    { ja: "å¥½ããªã‚¹ãƒãƒ¼ãƒ„", en: "Your favorite sport" },
    { ja: "å®¶æ—ã«ã¤ã„ã¦", en: "About your family" },
    { ja: "æ˜¨æ—¥é£Ÿã¹ãŸã‚‚ã®", en: "What you ate yesterday" },
    { ja: "ãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€", en: "Your favorite place" },
    { ja: "è‡ªå·±ç´¹ä»‹", en: "Introduce yourself" },
    { ja: "æœ€è¿‘èª­ã‚“ã æœ¬ã‚„ãƒãƒ³ã‚¬", en: "A book or manga you read recently" },
    { ja: "ã‚¢ãƒ«ãƒã‚¤ãƒˆã«ã¤ã„ã¦", en: "About your part-time job" },
];
let currentTopicIndex = -1;

function shuffleTopics() { for (let i = topics.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [topics[i], topics[j]] = [topics[j], topics[i]]; } }
function changeTopic() { currentTopicIndex = (currentTopicIndex + 1) % topics.length; if (currentTopicIndex === 0) shuffleTopics(); document.getElementById('topicText').textContent = topics[currentTopicIndex].ja; document.getElementById('topicTextEn').textContent = topics[currentTopicIndex].en; }

// ============================================================
// Recording
// ============================================================
let mediaRecorder = null, audioChunks = [], audioStream = null, isRecording = false;
let timerInterval = null, timeLeft = 60;
let audioContext = null, analyser = null, animFrameId = null;

function toggleRecording() { isRecording ? stopRecording() : startRecording(); }

async function startRecording() {
    hideError();

    try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
        showError(err.name === 'NotAllowedError' ? 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚' : `ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼: ${err.message}`);
        return;
    }

    // Audio level visualization
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    audioContext.createMediaStreamSource(audioStream).connect(analyser);
    analyser.fftSize = 256;
    const dataArr = new Uint8Array(analyser.frequencyBinCount);
    const levelBar = document.getElementById('audioLevelBar');
    function updateLevel() { if (!isRecording) return; analyser.getByteFrequencyData(dataArr); const avg = dataArr.reduce((a,b)=>a+b,0)/dataArr.length; levelBar.style.width = Math.min(100,(avg/128)*100)+'%'; animFrameId = requestAnimationFrame(updateLevel); }

    // MediaRecorder
    audioChunks = [];
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
    mediaRecorder = new MediaRecorder(audioStream, mime ? {mimeType: mime} : {});
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => processRecording();
    mediaRecorder.onerror = e => { console.error('MediaRecorder error:', e); };
    mediaRecorder.start();
    isRecording = true;
    timeLeft = 60;

    // UI
    document.getElementById('recordingArea').classList.add('is-recording');
    document.getElementById('recordBtn').classList.add('recording');
    document.getElementById('recordBtn').textContent = 'â¹';
    document.getElementById('recordBtnLabel').textContent = 'è©±ã—ã¦ãã ã•ã„ï¼ ã‚¿ãƒƒãƒ—ã§çµ‚äº†';
    document.getElementById('resultsSection').classList.remove('visible');
    document.getElementById('processingCard').classList.remove('visible');

    updateTimerDisplay();
    updateLevel();
    timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) stopRecording(); }, 1000);
}

function stopRecording() {
    isRecording = false;
    clearInterval(timerInterval);
    if (animFrameId) cancelAnimationFrame(animFrameId);
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    if (audioStream) audioStream.getTracks().forEach(t => t.stop());
    if (audioContext) audioContext.close().catch(()=>{});

    document.getElementById('recordingArea').classList.remove('is-recording');
    const btn = document.getElementById('recordBtn');
    btn.classList.remove('recording'); btn.textContent = 'ğŸ¤'; btn.disabled = true;
    document.getElementById('recordBtnLabel').textContent = 'å‡¦ç†ä¸­...';
}

// ============================================================
// Processing
// ============================================================
async function processRecording() {
    const elapsed = 60 - timeLeft;
    if (audioChunks.length === 0) { showError('éŸ³å£°ãŒéŒ²éŸ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); resetButton(); return; }

    document.getElementById('processingCard').classList.add('visible');
    document.getElementById('processingText').textContent = 'Whisper AIã§æ–‡å­—èµ·ã“ã—ä¸­...';

    const blob = new Blob(audioChunks, { type: audioChunks[0].type || 'audio/webm' });

    try {
        const transcript = await transcribeWhisper(blob);
        if (!transcript || !transcript.trim()) { document.getElementById('processingCard').classList.remove('visible'); showError('éŸ³å£°ã‚’æ–‡å­—ã«å¤‰æ›ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†å°‘ã—å¤§ããªå£°ã§è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚'); resetButton(); return; }

        document.getElementById('processingText').textContent = 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆä¸­...';
        showResults(transcript.trim(), elapsed);
    } catch (err) {
        document.getElementById('processingCard').classList.remove('visible');
        showError('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        resetButton();
    }
}

// ============================================================
// API calls via Cloudflare Worker proxy
// ============================================================
async function transcribeWhisper(blob) {
    const fd = new FormData();
    fd.append('file', blob, 'recording.webm');
    fd.append('model', 'whisper-1');
    fd.append('language', 'en');
    fd.append('response_format', 'text');

    const res = await fetch(API_BASE + '/transcribe', {
        method: 'POST',
        body: fd
    });
    if (!res.ok) {
        const e = await res.json().catch(()=>({}));
        throw new Error(e.error || `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${res.status}`);
    }
    return await res.text();
}

async function generateFeedback(transcript, wpm, cefr) {
    const topicJa = document.getElementById('topicText').textContent;
    const topicEn = document.getElementById('topicTextEn').textContent;

    const prompt = `ã‚ãªãŸã¯æ—¥æœ¬ã®å¤§å­¦ã§è‹±èªã‚’æ•™ãˆã¦ã„ã‚‹å„ªã—ã„è‹±èªæ•™å¸«ã§ã™ã€‚è‹±èªåˆç´šãƒ¬ãƒ™ãƒ«ï¼ˆCEFR A1ã€œA2ï¼‰ã®æ—¥æœ¬äººå¤§å­¦1å¹´ç”ŸãŒã€ã€Œç‹¬ã‚Šè¨€è‹±ä¼šè©±ã€ã®ç·´ç¿’ã‚’ã—ã¾ã—ãŸã€‚

ãƒˆãƒ”ãƒƒã‚¯: ${topicJa} (${topicEn})
èªæ•°/åˆ†: ${wpm} WPM
æ¨å®šCEFRãƒ¬ãƒ™ãƒ«: ${cefr}

å­¦ç”Ÿã®ã‚¹ãƒ”ãƒ¼ãƒæ–‡å­—èµ·ã“ã—ï¼š
"""
${transcript}
"""

æ—¥æœ¬èªã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’JSONå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ï¼‰ï¼š
{
  "good_points": [
    "ï¼ˆã‚¹ãƒ”ãƒ¼ãƒã®å…·ä½“çš„ãªå†…å®¹ã«è¨€åŠã—ãŸè‰¯ã„ç‚¹1ï¼‰",
    "ï¼ˆã‚¹ãƒ”ãƒ¼ãƒã®å…·ä½“çš„ãªå†…å®¹ã«è¨€åŠã—ãŸè‰¯ã„ç‚¹2ï¼‰"
  ],
  "grammar_notes": [
    "ï¼ˆæ–‡å­—èµ·ã“ã—ã‹ã‚‰å…·ä½“çš„ãªç®‡æ‰€ã‚’ã€Œã€ã§å¼•ç”¨ã—ã€æ–‡æ³•ã®æ³¨æ„ç‚¹ã‚’æŒ‡æ‘˜ã€‚æ­£ã—ã„è¡¨ç¾ã‚‚ç¤ºã™ï¼‰"
  ],
  "encouragement": "ï¼ˆå…·ä½“çš„ã«è¤’ã‚ã¦ã€æ¬¡å›ã¸ã®åŠ±ã¾ã—ã®è¨€è‘‰ï¼‰"
}

é‡è¦ï¼šgood_pointsã§ã¯ã‚¹ãƒ”ãƒ¼ãƒã®å…·ä½“çš„ãªå†…å®¹ã«å¿…ãšè¨€åŠã€‚grammar_notesã§ã¯æ–‡å­—èµ·ã“ã—ã‹ã‚‰å…·ä½“çš„ã«å¼•ç”¨ã—ã¦ä¿®æ­£æ¡ˆã‚’ç¤ºã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯é¿ã‘ã‚‹ã€‚`;

    try {
        const res = await fetch(API_BASE + '/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
        });
        if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error || `ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${res.status}`); }
        const data = await res.json();
        const text = data.text;
        const m = text.match(/\{[\s\S]*\}/);
        if (!m) throw new Error('Invalid format');
        displayFeedback(JSON.parse(m[0]));
    } catch (err) {
        document.getElementById('feedbackContent').innerHTML = `<p style="color:var(--recording);font-size:0.85rem;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
    }
}

// ============================================================
// Results display
// ============================================================
function showResults(transcript, elapsed) {
    const wc = countWords(transcript);
    const wpm = elapsed > 0 ? Math.round((wc / elapsed) * 60) : 0;
    const cefr = estimateCEFR(wpm, transcript);

    document.getElementById('processingCard').classList.remove('visible');
    document.getElementById('resultsSection').classList.add('visible');
    document.getElementById('wpmValue').textContent = wpm;
    document.getElementById('cefrValue').textContent = cefr;
    document.getElementById('finalTranscript').textContent = transcript;
    document.getElementById('feedbackContent').innerHTML = '<div style="text-align:center"><div class="loading-dots"><span></span><span></span><span></span></div><div class="loading-text">AIãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆä¸­...</div></div>';

    generateFeedback(transcript, wpm, cefr);
    resetButton();
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function countWords(t) { return t.trim().split(/\s+/).filter(w=>w.length>0).length; }

function estimateCEFR(wpm, transcript) {
    const wc = countWords(transcript), uw = new Set(transcript.toLowerCase().split(/\s+/)).size;
    const ld = uw / Math.max(wc, 1), awl = transcript.replace(/\s+/g,'').length / Math.max(wc, 1);
    let s = 0;
    if (wpm >= 130) s += 5; else if (wpm >= 110) s += 4; else if (wpm >= 90) s += 3; else if (wpm >= 60) s += 2; else if (wpm >= 30) s += 1;
    if (ld >= 0.75) s += 3; else if (ld >= 0.6) s += 2; else if (ld >= 0.45) s += 1;
    if (awl >= 5.5) s += 2; else if (awl >= 4.5) s += 1;
    if (s >= 9) return 'B2'; if (s >= 7) return 'B1'; if (s >= 5) return 'A2'; if (s >= 3) return 'A1'; return 'Pre-A1';
}

function displayFeedback(fb) {
    let h = '';
    if (fb.good_points?.length) { h += '<h3 style="margin-bottom:10px">âœ¨ è‰¯ã‹ã£ãŸç‚¹</h3>'; fb.good_points.forEach(p => h += `<div class="good-point">${esc(p)}</div>`); }
    if (fb.grammar_notes?.length) { h += '<h3 style="margin-top:18px;margin-bottom:10px">ğŸ“ æ–‡æ³•ã®æ³¨æ„ç‚¹</h3>'; fb.grammar_notes.forEach(n => h += `<div class="grammar-point">${esc(n)}</div>`); }
    if (fb.encouragement) h += `<div class="encouragement">ğŸ’ª ${esc(fb.encouragement)}</div>`;
    document.getElementById('feedbackContent').innerHTML = h;
}

// ============================================================
// Utilities
// ============================================================
function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function showError(m) { const e = document.getElementById('errorMsg'); e.textContent = m; e.classList.add('visible'); }
function hideError() { document.getElementById('errorMsg').classList.remove('visible'); }
function resetButton() { const b = document.getElementById('recordBtn'); b.disabled = false; document.getElementById('recordBtnLabel').textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹'; }
function updateTimerDisplay() { const m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timer').textContent = `${m}:${s.toString().padStart(2,'0')}`; }

function resetApp() {
    document.getElementById('resultsSection').classList.remove('visible');
    document.getElementById('processingCard').classList.remove('visible');
    timeLeft = 60; updateTimerDisplay(); audioChunks = []; resetButton(); changeTopic();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Init
shuffleTopics(); changeTopic();
</script>
</body>
</html>
